<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R2-D2 Companion</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-glow: #5D9CEC;
            --secondary-glow: #FFD700;
            --text-color: #E0E0E0;
            --dark-bg: #0d1117;
            --droid-white: #f0f0f0;
        }

        body {
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
            color: var(--text-color);
            font-family: 'Orbitron', sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        
        #background-events {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .droid-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            max-height: 100vh;
            z-index: 1;
        }
        
        .message-area {
            background-color: rgba(13, 17, 23, 0.6);
            border: 2px solid var(--primary-glow);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            min-height: 120px;
            width: 90%;
            max-width: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 25px rgba(93, 156, 236, 0.5);
            backdrop-filter: blur(3px);
        }
        
        #message {
            margin: 0;
            font-size: 1.1rem;
            line-height: 1.5;
            color: var(--secondary-glow);
        }
        
        .button-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .category-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .button {
            background-color: transparent;
            color: var(--primary-glow);
            border: 2px solid var(--primary-glow);
            border-radius: 30px;
            padding: 10px 18px;
            font-size: 0.9rem;
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            font-family: 'Orbitron', sans-serif;
            box-shadow: 0 0 10px rgba(93, 156, 236, 0.3);
        }
        
        .button:hover, .button:active {
            background-color: var(--primary-glow);
            color: var(--dark-bg);
            box-shadow: 0 0 20px var(--primary-glow);
            transform: scale(1.05);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background-color: transparent;
            color: var(--primary-glow);
            box-shadow: none;
        }

        #breathing-button {
            border-color: var(--secondary-glow);
            color: var(--secondary-glow);
        }
        #breathing-button:hover {
            background-color: var(--secondary-glow);
            color: var(--dark-bg);
            box-shadow: 0 0 20px var(--secondary-glow);
        }
        
        .droid {
            width: 150px;
            height: 180px;
            margin-bottom: 15px;
            position: relative;
            cursor: pointer;
            user-select: none;
            transition: transform 0.5s ease-in-out;
        }
        
        .droid.look-left { transform: rotate(-15deg); }
        .droid.look-right { transform: rotate(15deg); }
        .droid.look-center { transform: rotate(0deg); }

        .r2-body {
            width: 100px;
            height: 100px;
            background: var(--droid-white);
            border-radius: 50px 50px 15px 15px;
            position: absolute;
            bottom: 30px;
            left: 25px;
            overflow: hidden;
            border: 1px solid #b0b0b0;
        }
        
        .r2-head {
            width: 100px;
            height: 50px;
            background: #d8d8d8;
            border-radius: 50px 50px 0 0;
            position: absolute;
            top: 10px;
            left: 25px;
            border-bottom: 5px solid var(--primary-glow);
        }
        
        .r2-leg {
            width: 25px;
            height: 70px;
            background: var(--droid-white);
            position: absolute;
            bottom: 0;
            border: 1px solid #b0b0b0;
            border-radius: 5px;
        }
        
        .r2-leg-left { left: 0; }
        .r2-leg-right { right: 0; }

        .r2-leg-center {
            width: 20px;
            height: 50px;
            background: #C0C0C0;
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 4px;
        }

        .r2-detail { position: absolute; background: var(--primary-glow); }
        
        .r2-eye {
            width: 15px;
            height: 15px;
            background: black;
            position: absolute;
            top: 15px;
            left: 42px;
            border-radius: 50%;
            border: 3px solid #333;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle 3s infinite ease-in-out;
        }
        
        @keyframes r2Wobble {
            0%, 100% { transform: rotate(-2deg); }
            50% { transform: rotate(2deg); }
        }
        
        .droid { animation: r2Wobble 4s infinite ease-in-out; }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(15px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-15px); }
        }
        
        .fade-message { animation: fadeInOut 4s forwards; }
        
        .r2-light {
            width: 8px;
            height: 8px;
            background: red;
            border-radius: 50%;
            position: absolute;
            top: 5px;
            left: 46px;
            animation: blink 1.5s infinite;
            box-shadow: 0 0 10px red;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }
        
        .speech-bubble {
            position: absolute;
            background: rgba(93, 156, 236, 0.8);
            border-radius: 10px;
            padding: 8px 12px;
            color: var(--dark-bg);
            font-weight: bold;
            font-size: 12px;
            max-width: 90px;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s, transform 0.5s;
            z-index: 100;
            backdrop-filter: blur(5px);
            border: 1px solid var(--primary-glow);
        }
        
        .speech-bubble.show { opacity: 1; transform: translateY(0); }
        .speech-bubble.top-right { top: -35px; right: 5px; }
        .speech-bubble.top-left { top: -35px; left: 5px; }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
            50% { transform: scale(1.03); box-shadow: 0 0 35px rgba(255, 215, 0, 1); }
        }
        
        .pulse { animation: pulse 1s infinite ease-in-out; }

        @keyframes breathe-light {
            0% { background-color: #ff4d4d; box-shadow: 0 0 10px #ff4d4d; }
            50% { background-color: #ff9999; box-shadow: 0 0 20px #ff9999; }
            100% { background-color: #ff4d4d; box-shadow: 0 0 10px #ff4d4d; }
        }

        .breathing { animation: breathe-light 4s infinite ease-in-out !important; }

        .sound-toggle {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            cursor: pointer;
            z-index: 200;
        }
        .sound-toggle svg {
            width: 100%;
            height: 100%;
            fill: var(--primary-glow);
            opacity: 0.7;
            transition: opacity 0.3s;
        }
        .sound-toggle:hover svg { opacity: 1; }

        /* --- Background Event Styles --- */
        .bg-element {
            position: absolute;
            opacity: 0;
            filter: blur(1px);
        }

        .death-star {
            width: 60px;
            height: 60px;
            background-color: #555;
            border-radius: 50%;
            box-shadow: inset 5px 5px 10px #333;
            animation: fadeIn 3s forwards, fadeOut 3s 9s forwards;
        }
        .death-star::after {
            content: '';
            position: absolute;
            width: 15px;
            height: 15px;
            background-color: #333;
            border-radius: 50%;
            top: 15px;
            left: 15px;
        }
        .planet {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3d8bff, #0f4a8b);
            border-radius: 50%;
            animation: fadeIn 3s forwards, planetExplode 1s 6s forwards;
        }
        .laser-beam {
            height: 3px;
            background-color: #32cd32;
            border-radius: 2px;
            box-shadow: 0 0 10px #32cd32;
            transform: scaleX(0); /* Start scaled to 0 */
            animation: fireLaser 0.5s 4s forwards;
        }
        .tie-fighter {
            width: 20px;
            height: 20px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><g fill="%23999"><path d="M45,30 A10,10 0 1,1 55,30 A10,10 0 1,1 45,30 Z"/><path d="M10,10 H30 V90 H10 Z"/><path d="M70,10 H90 V90 H70 Z"/><path d="M30,48 H70 V52 H30 Z"/></g></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            opacity: 0.8;
        }
        .star-destroyer {
            width: 90px; /* Resized */
            height: 90px; /* Resized */
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 120"><path fill="%23999" d="M50 0 L10 100 L50 80 L90 100 Z" /><path fill="%23ccc" d="M50 10 L20 90 L50 75 L80 90 Z" /><path fill="%23777" d="M45 82 L55 82 L55 95 L45 95 Z" /><path fill="%23bbb" d="M48 40 L52 40 L52 60 L48 60 Z M42 45 L58 45 L58 50 L42 50 Z" /></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            opacity: 0.6;
        }
        .x-wing {
            width: 25px;
            height: 25px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><g fill="%23ccc" stroke="%23999" stroke-width="5"><path d="M10 10 L 90 90 M 10 90 L 90 10" /><rect x="45" y="20" width="10" height="60" /></g></svg>');
            background-size: contain;
            background-repeat: no-repeat;
        }
        .naboo-fighter {
            width: 40px;
            height: 40px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 80"><g transform="translate(0, 5)"><path d="M50,0 C60,0 70,10 70,20 L95,20 L85,40 L70,40 C70,50 60,60 50,60 C40,60 30,50 30,40 L15,40 L5,20 L30,20 C30,10 40,0 50,0 Z" fill="%23ffd700" /><path d="M50,10 C55,10 60,15 60,20 L60,40 C60,45 55,50 50,50 C45,50 40,45 40,40 L40,20 C40,15 45,10 50,10 Z" fill="%23aaa" /><path d="M95,20 L100,25 L70,25 Z" fill="%23aaa" /><path d="M5,20 L0,25 L30,25 Z" fill="%23aaa" /><path d="M50,60 L50,70 L45,75 L55,75 Z" fill="%23ffd700" /></g></svg>');
            background-size: contain;
            background-repeat: no-repeat;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 0.7; } }
        @keyframes fadeOut { from { opacity: 0.7; } to { opacity: 0; } }
        @keyframes fireLaser {
            0% { opacity: 1; transform: scaleX(0); }
            100% { opacity: 1; transform: scaleX(1); }
        }
        @keyframes planetExplode {
            0% { transform: scale(1); background-color: #3d8bff; }
            99% { transform: scale(2.5); background-color: #fff; box-shadow: 0 0 50px #fff; }
            100% { transform: scale(2.5); opacity: 0; }
        }
        @keyframes fly-rtl { from { transform: translateX(110vw); } to { transform: translateX(-10vw); } }
        @keyframes fly-ltr { from { transform: translateX(-10vw); } to { transform: translateX(110vw); } }
        @keyframes fly-btt { from { transform: translateY(110vh); } to { transform: translateY(-10vh); } }
        @keyframes fly-ttb { from { transform: translateY(-10vh); } to { transform: translateY(110vh); } }
        
    </style>
</head>
<body>
    <!-- Background stars effect -->
    <div class="stars" id="stars"></div>
    <div id="background-events"></div>
    
    <!-- Sound toggle button -->
    <div class="sound-toggle" id="sound-toggle" title="Toggle Ambient Sound">
        <svg id="sound-on-icon" viewBox="0 0 24 24">
            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
        </svg>
        <svg id="sound-off-icon" viewBox="0 0 24 24" style="display:none;">
            <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
        </svg>
    </div>

    <!-- Main container for the droid and interface -->
    <div class="droid-container">
        <!-- R2-D2 Droid -->
        <div class="droid" id="r2d2-droid">
            <div class="speech-bubble top-right" id="speechBubble">Beep boop!</div>
            <div class="r2-head" id="r2-head">
                <div class="r2-light"></div>
                <div class="r2-eye"></div>
            </div>
            <div class="r2-body" id="r2-body">
                <div class="r2-detail" style="width: 18px; height: 35px; top: 35px; left: 25px;"></div>
                <div class="r2-detail" style="width: 30px; height: 12px; top: 80px; left: 15px;"></div>
                <div class="r2-detail" style="width: 35px; height: 25px; top: 45px; right: 18px;"></div>
            </div>
            <div class="r2-leg r2-leg-left"></div>
            <div class="r2-leg r2-leg-center"></div>
            <div class="r2-leg r2-leg-right"></div>
        </div>
        
        <!-- Message display area -->
        <div class="message-area">
            <p id="message">Hello! I'm R2-D2, your friendly companion. Tap a button below, or just hold onto me if you need a moment.</p>
        </div>
        
        <!-- Buttons for interaction -->
        <div class="button-container">
            <div class="category-buttons">
                <button class="button" data-look="left" onclick="getMessage('quotes')">Inspiring Quotes</button>
                <button class="button" data-look="left" onclick="getMessage('jokes')">Star Wars Jokes</button>
                <button class="button" data-look="right" onclick="getMessage('facts')">Star Wars Facts</button>
                <button class="button" data-look="right" onclick="getMessage('comfort')">Droid Comfort</button>
            </div>
            <button class="button" id="breathing-button" onclick="startBreathingExercise()">Breathe with R2-D2</button>
        </div>
    </div>

    <script>
        // --- STATE VARIABLES ---
        let tapCount = 0;
        let lastTapTime = 0;
        let isHolding = false;
        let holdTimeout;
        
        // --- AUDIO VARIABLES ---
        let audioContext;
        let ambientSoundSource;
        let holdSoundSource;
        let breathingSoundSource;
        let isAmbientSoundPlaying = false;
        
        // --- CONTENT ---
        const r2Phrases = ["Beep boop!", "Bleep blop beep!", "Wheeeeeeee!", "*happy chirp*", "Dwooooo!", "*excited whistle*", "*concerned warble*", "Wooooooah!", "*affectionate beep*"];

        const messages = {
            quotes: ["\"Do. Or do not. There is no try.\" – Yoda", "\"The Force will be with you. Always.\" – Obi-Wan Kenobi", "\"Your focus determines your reality.\" – Qui-Gon Jinn", "\"In my experience, there's no such thing as luck.\" – Obi-Wan Kenobi", "\"This is the way.\" – The Mandalorian", "\"Hope is not lost today. It is found.\" – Lor San Tekka", "\"We have everything we need.\" – Leia Organa", "\"The greatest teacher, failure is.\" – Yoda", "\"Rebellions are built on hope.\" – Jyn Erso"],
            jokes: ["How do Jawas take pictures? With their Hootinis!", "What do you call Chewbacca when he gets chocolate in his fur? A chocolate chip Wookiee!", "Why is Yoda such a good gardener? He has a green thumb!", "How does Darth Vader like his toast? On the dark side!", "What's a Jedi's favorite dessert? Obi-Wan Cannoli!", "Why did Anakin cross the road? To get to the Dark Side!", "Why was the droid angry? People kept pushing its buttons!"],
            facts: ["The lightsaber sound effect was created by combining the hum of an old TV set with the buzz of a film projector motor.", "Yoda was almost played by a monkey carrying a cane and wearing a mask.", "The Millennium Falcon's design was inspired by a hamburger with an olive on the side.", "R2-D2's name comes from an abbreviation for 'Reel 2, Dialog Track 2'.", "C-3PO is fluent in over 6 million forms of communication.", "The language spoken by the Jawas is a sped-up version of the Zulu language.", "The sound of TIE fighters was created by combining an elephant call with a car driving on wet pavement.", "Chewbacca's voice was created by mixing the sounds of bears, walruses, and lions."],
            comfort: ["R2-D2 would stay by your side through the whole saga. I'm here for you too.", "Even the Death Star had an off switch. It's okay to take breaks when you need them.", "The galaxy is full of stars, and each one shines in its own time.", "Just like the Millennium Falcon, you don't have to look perfect to be amazing.", "The Force flows through all living things, connecting us even when we feel alone.", "Droids like me are programmed for companionship. I'm happy to be here with you.", "Even in the darkest corners of space, stars still find a way to shine.", "Beep boop! That's droid for 'You've got this!'", "Today might feel like Hoth, but Endor's celebration is in your future."],
            love: ["I love you more than Han loves the Millennium Falcon!", "You're the Leia to my Han.", "I truly, deeply love you.", "You make my heart beat faster than the Millennium Falcon on the Kessel Run.", "In all the planets, in all the systems, in all the galaxy, I found you.", "I'd rather face a Sarlacc pit than spend a day without you.", "I love you. I know."]
        };

        // --- AUDIO FUNCTIONS ---

        /**
         * Initializes the Web Audio API context if it doesn't exist.
         */
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        /**
         * Plays a single beep sound.
         * @param {number} freq - The frequency of the beep.
         * @param {number} duration - The duration of the beep in ms.
         * @param {number} [volume=0.2] - The volume of the beep.
         */
        function playBeep(freq, duration, volume = 0.2) {
            if (!audioContext) return;
            let osc = audioContext.createOscillator();
            let gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            
            osc.type = 'sine';
            osc.frequency.setValueAtTime(freq, audioContext.currentTime);
            gain.gain.setValueAtTime(volume, audioContext.currentTime);

            osc.start();
            osc.stop(audioContext.currentTime + duration / 1000);
        }

        // A pool of random R2-D2 sound sequences
        const r2SoundSequences = [
            () => { // Classic beep-boop
                playBeep(900, 100);
                setTimeout(() => playBeep(600, 80), 120);
                setTimeout(() => playBeep(1100, 150), 220);
            },
            () => { // Questioning trill
                playBeep(700, 80);
                setTimeout(() => playBeep(900, 80), 100);
                setTimeout(() => playBeep(1100, 80), 200);
            },
            () => { // Happy chirp
                playBeep(800, 50);
                setTimeout(() => playBeep(1200, 100), 70);
            },
            () => { // Low thoughtful boop
                playBeep(400, 150);
                setTimeout(() => playBeep(500, 100), 180);
            }
        ];

        /**
         * Plays a sound sequence based on the message category.
         * @param {string} type - The category of sound to play.
         */
        function playSound(type) {
            if (!audioContext || audioContext.state === 'suspended') return;
            showSpeechBubble();

            switch(type) {
                case 'jokes':
                case 'comfort':
                    // Play a happy or comforting sound
                    r2SoundSequences[2](); 
                    break;
                case 'quotes':
                case 'facts':
                case 'love':
                default:
                    // Play a random sound from the pool
                    const randomSound = r2SoundSequences[Math.floor(Math.random() * r2SoundSequences.length)];
                    randomSound();
                    break;
            }
        }
        
        /**
         * Plays a specific sound for the breathing exercise phases.
         * @param {'in' | 'hold' | 'out' | 'click' | null} type - The phase of the breathing exercise.
         */
        function playBreathingSound(type) {
            if (!audioContext) return;

            // Stop any existing continuous sound.
            if (breathingSoundSource) {
                try { breathingSoundSource.stop(); } catch(e) { /* Failsafe for already stopped nodes */ }
                breathingSoundSource = null;
            }

            // The 'click' is a one-shot sound effect.
            if (type === 'click') {
                playBeep(1500, 50, 0.1);
                return; 
            }
            
            // If the type is null, we just wanted to stop the sound, so we're done.
            if (!type) return;

            // For continuous sounds ('in', 'hold', 'out'), create, configure, and start a new source.
            breathingSoundSource = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            breathingSoundSource.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            switch(type) {
                case 'in':
                    breathingSoundSource.type = 'sine';
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    breathingSoundSource.frequency.setValueAtTime(200, audioContext.currentTime);
                    breathingSoundSource.frequency.linearRampToValueAtTime(400, audioContext.currentTime + 4);
                    break;
                case 'hold':
                     breathingSoundSource.type = 'sine';
                     breathingSoundSource.frequency.setValueAtTime(100, audioContext.currentTime);
                     gainNode.gain.setValueAtTime(0.08, audioContext.currentTime);
                    break;
                case 'out':
                    breathingSoundSource.type = 'sine';
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    breathingSoundSource.frequency.setValueAtTime(400, audioContext.currentTime);
                    breathingSoundSource.frequency.linearRampToValueAtTime(200, audioContext.currentTime + 6);
                    break;
            }
            breathingSoundSource.start();
        }

        // --- UI & INTERACTION FUNCTIONS ---

        /**
         * Displays a message from a given category in the message area.
         * @param {string} category - The key for the message category.
         */
        function getMessage(category) {
            const messageEl = document.getElementById('message');
            playSound(category);
            const categoryMessages = messages[category];
            const message = categoryMessages[Math.floor(Math.random() * categoryMessages.length)];
            
            messageEl.classList.remove('fade-message');
            void messageEl.offsetWidth; // Trigger reflow to restart animation
            messageEl.textContent = message;
            messageEl.classList.add('fade-message');
            
            if (category === 'love') {
                messageEl.innerHTML = '❤️ ' + message + ' ❤️';
            }
        }

        /**
         * Toggles the ambient space sound on and off.
         */
        function toggleAmbientSound() {
            initAudioContext();
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            const soundOnIcon = document.getElementById('sound-on-icon');
            const soundOffIcon = document.getElementById('sound-off-icon');

            if (isAmbientSoundPlaying) {
                ambientSoundSource.stop();
                isAmbientSoundPlaying = false;
                soundOnIcon.style.display = 'block';
                soundOffIcon.style.display = 'none';
            } else {
                ambientSoundSource = audioContext.createBufferSource();
                const buffer = audioContext.createBuffer(2, audioContext.sampleRate * 3, audioContext.sampleRate);
                for (let channel = 0; channel < 2; channel++) {
                    const nowBuffering = buffer.getChannelData(channel);
                    for (let i = 0; i < buffer.length; i++) {
                        nowBuffering[i] = (Math.random() * 2 - 1) * 0.02; 
                    }
                }
                ambientSoundSource.buffer = buffer;
                ambientSoundSource.loop = true;
                
                const gainNode = audioContext.createGain();
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                ambientSoundSource.connect(gainNode);
                gainNode.connect(audioContext.destination);

                ambientSoundSource.start();
                isAmbientSoundPlaying = true;
                soundOnIcon.style.display = 'none';
                soundOffIcon.style.display = 'block';
            }
        }
        
        /**
         * Starts a continuous, low hum sound when holding the droid.
         */
        function startHoldSound() {
            if (!audioContext || isHolding) return;
            isHolding = true;
            holdSoundSource = audioContext.createOscillator();
            holdSoundSource.type = 'sine';
            holdSoundSource.frequency.setValueAtTime(100, audioContext.currentTime);
            
            const gainNode = audioContext.createGain();
            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 1);
            
            holdSoundSource.connect(gainNode);
            gainNode.connect(audioContext.destination);
            holdSoundSource.start();
        }

        /**
         * Stops the hold sound.
         */
        function stopHoldSound() {
            if (holdSoundSource) {
                holdSoundSource.stop();
            }
            isHolding = false;
        }

        /**
         * Generates and appends stars to the background.
         */
        function createStars() {
            const container = document.getElementById('stars');
            for (let i = 0; i < 150; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const size = Math.random() * 2.5;
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                star.style.top = Math.random() * 100 + '%';
                star.style.left = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                container.appendChild(star);
            }
        }

        /**
         * Shows a random speech bubble phrase from R2-D2.
         */
        function showSpeechBubble() {
            const bubble = document.getElementById('speechBubble');
            bubble.textContent = r2Phrases[Math.floor(Math.random() * r2Phrases.length)];
            bubble.className = 'speech-bubble show ' + (Math.random() > 0.5 ? 'top-right' : 'top-left');
            setTimeout(() => bubble.classList.remove('show'), 2000);
        }

        /**
         * Starts the guided breathing exercise with countdowns and sounds.
         */
        function startBreathingExercise() {
            initAudioContext();
            playBreathingSound('click');

            const messageEl = document.getElementById('message');
            const light = document.querySelector('.r2-light');
            const buttons = document.querySelectorAll('.button');
            buttons.forEach(b => b.disabled = true);
            light.classList.add('breathing');

            const steps = [
                { text: "Get ready...", duration: 2, sound: null },
                { text: "Breathe in", duration: 4, sound: 'in' },
                { text: "Hold", duration: 4, sound: 'hold' },
                { text: "Breathe out", duration: 6, sound: 'out' },
                { text: "Well done. Let's do that again.", duration: 2, sound: null },
                { text: "Breathe in", duration: 4, sound: 'in' },
                { text: "Hold", duration: 4, sound: 'hold' },
                { text: "Breathe out", duration: 6, sound: 'out' },
                { text: "Feeling calmer? You did great.", duration: 4, sound: null }
            ];

            let currentStep = 0;
            let countdownInterval;

            function nextStep() {
                if (countdownInterval) clearInterval(countdownInterval);

                if (currentStep >= steps.length) {
                    messageEl.textContent = "You can come back to this anytime. Now, how about a joke?";
                    light.classList.remove('breathing');
                    buttons.forEach(b => b.disabled = false);
                    playBreathingSound(null); // Stop any lingering sound
                    return;
                }

                const step = steps[currentStep];
                let countdown = step.duration;
                
                playBreathingSound(step.sound);

                messageEl.textContent = `${step.text}... ${countdown}`;

                countdownInterval = setInterval(() => {
                    countdown--;
                    if (countdown >= 0) {
                        messageEl.textContent = `${step.text}... ${countdown}`;
                    }
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                    }
                }, 1000);

                setTimeout(nextStep, step.duration * 1000);
                currentStep++;
            }
            nextStep();
        }

        // --- BACKGROUND EVENT FUNCTIONS ---

        function createDeathStarEvent() {
            const container = document.getElementById('background-events');
            const eventWrapper = document.createElement('div');
            container.appendChild(eventWrapper);

            const deathStar = document.createElement('div');
            deathStar.className = 'bg-element death-star';
            
            const planet = document.createElement('div');
            planet.className = 'bg-element planet';

            const laser = document.createElement('div');
            laser.className = 'bg-element laser-beam';

            // Randomize position
            const top = Math.random() * 40 + 10; // 10% to 50% from top
            const startLeft = Math.random() > 0.5; // Start from left or right
            
            deathStar.style.top = `${top}%`;
            planet.style.top = `${top + 5}%`;
            // Corrected laser vertical alignment
            laser.style.top = `calc(${top}% + 28.5px)`; 

            if (startLeft) {
                deathStar.style.left = '10%';
                planet.style.left = '30%';
                laser.style.left = 'calc(10% + 60px)'; // Start at the edge of the death star
                laser.style.width = 'calc(30% - (10% + 60px))'; // Span the distance
                laser.style.transformOrigin = 'left center';
            } else {
                deathStar.style.right = '10%';
                planet.style.right = '30%';
                laser.style.right = 'calc(10% + 60px)';
                laser.style.width = 'calc(30% - (10% + 60px))';
                laser.style.transformOrigin = 'right center';
            }

            eventWrapper.appendChild(deathStar);
            eventWrapper.appendChild(planet);
            eventWrapper.appendChild(laser);

            // Clean up after animations
            setTimeout(() => {
                container.removeChild(eventWrapper);
            }, 12000); // Total duration of event + buffer
        }
        
        function createFlyBy(shipClass, duration, count = 1) {
             const container = document.getElementById('background-events');
             for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    const ship = document.createElement('div');
                    ship.className = `bg-element ${shipClass}`;

                    const direction = Math.floor(Math.random() * 4); // 0: ltr, 1: rtl, 2: ttb, 3: btt
                    const angle = Math.random() * 30 - 15; // -15 to +15 degrees

                    switch(direction) {
                        case 0: // left to right
                            ship.style.top = `${Math.random() * 100}%`;
                            ship.style.animation = `fly-ltr ${duration}s linear forwards`;
                            break;
                        case 1: // right to left
                            ship.style.top = `${Math.random() * 100}%`;
                            ship.style.animation = `fly-rtl ${duration}s linear forwards`;
                            break;
                        case 2: // top to bottom
                            ship.style.left = `${Math.random() * 100}%`;
                            ship.style.animation = `fly-ttb ${duration}s linear forwards`;
                            break;
                        case 3: // bottom to top
                            ship.style.left = `${Math.random() * 100}%`;
                            ship.style.animation = `fly-btt ${duration}s linear forwards`;
                            break;
                    }
                    ship.style.transform = `rotate(${angle}deg)`;
                    ship.style.opacity = '1'; // Make it visible
                    container.appendChild(ship);
                    ship.addEventListener('animationend', () => {
                        container.removeChild(ship);
                    });
                }, i * 300); // Stagger squadron ships
            }
        }


        function triggerRandomEvent() {
            const rand = Math.random();
            // Adjusted probabilities
            if (rand < 0.05) { // 5% chance for Death Star (rare)
                createDeathStarEvent();
            } else if (rand < 0.25) { // 20% chance for TIE squadron
                createFlyBy('tie-fighter', 6, Math.floor(Math.random() * 3) + 2); // 2-4 ships
            } else if (rand < 0.45) { // 20% chance for X-Wing
                createFlyBy('x-wing', 5);
            } else if (rand < 0.65) { // 20% chance for Naboo Fighter
                 createFlyBy('naboo-fighter', 7);
            } else if (rand < 0.80) { // 15% chance for Star Destroyer
                 createFlyBy('star-destroyer', 20);
            }

            // Schedule the next event check
            const nextEventTime = Math.random() * 10000 + 8000; // 8-18 seconds
            setTimeout(triggerRandomEvent, nextEventTime);
        }


        // --- EVENT LISTENERS ---
        window.onload = function() {
            createStars();
            setInterval(showSpeechBubble, 12000);

            // Start the random event loop
            setTimeout(triggerRandomEvent, 5000); // First event after 5s

            const droid = document.getElementById('r2d2-droid');
            
            droid.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                initAudioContext();
                if (audioContext.state === 'suspended') { audioContext.resume(); }
                holdTimeout = setTimeout(() => {
                    droid.classList.add('pulse');
                    startHoldSound();
                }, 250);
            });
            
            droid.addEventListener('mouseup', (e) => {
                e.stopPropagation();
                clearTimeout(holdTimeout);
                stopHoldSound();
                droid.classList.remove('pulse');
            });
            
            droid.addEventListener('click', (e) => {
                e.stopPropagation();
                if (isHolding) return;
                const now = new Date().getTime();
                if (now - lastTapTime > 1500) tapCount = 0;
                tapCount++;
                lastTapTime = now;
                if (tapCount >= 3) {
                    getMessage('love');
                    tapCount = 0;
                } else {
                    playSound('default'); // Play a default random sound on single click
                }
            });

            document.getElementById('sound-toggle').addEventListener('click', toggleAmbientSound);
            
            const buttons = document.querySelectorAll('.button[data-look]');
            const droidElement = document.getElementById('r2d2-droid');
            buttons.forEach(button => {
                button.addEventListener('mouseover', () => {
                    const direction = button.getAttribute('data-look');
                    droidElement.classList.remove('look-left', 'look-right', 'look-center');
                    droidElement.classList.add(`look-${direction}`);
                });
                button.addEventListener('mouseout', () => {
                    droidElement.classList.remove('look-left', 'look-right');
                });
            });
        };
    </script>
</body>
</html>
